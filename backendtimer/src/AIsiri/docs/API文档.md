# AIsiri AIä»»åŠ¡åŠ©æ‰‹ APIæ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

AIsiri AIä»»åŠ¡åŠ©æ‰‹åŸºäºLangChainæ¶æ„ï¼Œæä¾›æ™ºèƒ½ä»»åŠ¡ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬è¾“å…¥åˆ†ç±»ã€é—®é¢˜ç”Ÿæˆã€è®¡åˆ’åˆ¶å®šå’Œä»»åŠ¡è°ƒæ•´ç­‰èƒ½åŠ›ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨
```bash
cd backendtimer
node test_server.js
```

æœåŠ¡å™¨å°†åœ¨ `http://localhost:3001` å¯åŠ¨

### åŸºæœ¬è¯·æ±‚æ ¼å¼
æ‰€æœ‰POSTè¯·æ±‚éƒ½éœ€è¦è®¾ç½®Content-Typeä¸ºapplication/json

```bash
curl -X POST http://localhost:3001/api/ai/[endpoint] \
  -H "Content-Type: application/json" \
  -d '{"å‚æ•°å": "å‚æ•°å€¼"}'
```

## ğŸ“¡ APIæ¥å£

### 1. å¥åº·æ£€æŸ¥

#### `GET /api/ai/health`
æ£€æŸ¥AIæœåŠ¡è¿è¡ŒçŠ¶æ€

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "message": "AIæœåŠ¡è¿è¡Œæ­£å¸¸",
  "timestamp": "2025-08-05T17:32:01.794Z",
  "uptime": 123.45
}
```

### 2. ç³»ç»ŸçŠ¶æ€

#### `GET /api/ai/status`
è·å–AIç³»ç»Ÿè¯¦ç»†çŠ¶æ€ä¿¡æ¯

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "status": {
    "ai_service": "running",
    "available_chains": [
      "input_classifier",
      "question_generator",
      "plan_generator",
      "plan_adjuster",
      "habit_processor"
    ],
    "prompt_templates": ["input_classifier", "question_generator", ...],
    "model_info": {
      "model": "qwen-plus",
      "provider": "Qwen/é˜¿é‡Œäº‘"
    }
  }
}
```

### 3. AIè¿æ¥æµ‹è¯•

#### `GET /api/ai/test-connection`
æµ‹è¯•ä¸å¤§è¯­è¨€æ¨¡å‹çš„è¿æ¥çŠ¶æ€

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "message": "AIæœåŠ¡è¿æ¥æ­£å¸¸",
  "model": "qwen-plus",
  "timestamp": "2025-08-05T17:32:01.794Z"
}
```

### 4. è¾“å…¥åˆ†ç±»

#### `POST /api/ai/classify-input`
å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œåˆ†ç±»è¯†åˆ«

**è¯·æ±‚å‚æ•°:**
- `userInput` (string, å¿…éœ€): ç”¨æˆ·è¾“å…¥å†…å®¹

**è¯·æ±‚ç¤ºä¾‹:**
```json
{
  "userInput": "å–ä¸ªå¤–å–"
}
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "userInput": "å–ä¸ªå¤–å–",
  "classification": {
    "category": "simple_todo",
    "confidence": 0.95,
    "reason": "ç”¨æˆ·è¾“å…¥çš„æ˜¯ä¸€ä¸ªç®€å•ã€ä¸€æ¬¡æ€§çš„å…·ä½“ä»»åŠ¡ï¼Œä¸éœ€è¦é•¿æœŸè§„åˆ’æˆ–é‡å¤æ‰§è¡Œã€‚"
  },
  "timestamp": "2025-08-05T17:32:17.838Z"
}
```

**åˆ†ç±»ç±»å‹:**
- `simple_todo`: ç®€å•å¾…åŠäº‹é¡¹ï¼ˆå¦‚å–å¤–å–ã€ä¹°èœç­‰ï¼‰
- `goal_planning`: ç›®æ ‡è§„åˆ’ï¼ˆå¦‚å­¦ç¼–ç¨‹ã€è€ƒç ”ç­‰ï¼‰
- `habit_formation`: ä¹ æƒ¯å…»æˆï¼ˆå¦‚æ¯å¤©è·‘æ­¥ã€é˜…è¯»ç­‰ï¼‰

### 5. é—®é¢˜ç”Ÿæˆ

#### `POST /api/ai/generate-questions`
æ ¹æ®ç”¨æˆ·ç›®æ ‡ç”Ÿæˆæ”¶é›†ä¿¡æ¯çš„é—®é¢˜

**è¯·æ±‚å‚æ•°:**
- `goal` (string, å¿…éœ€): ç”¨æˆ·ç›®æ ‡
- `goalType` (string, å¿…éœ€): ç›®æ ‡ç±»å‹ (goal_planning | habit_formation)

**è¯·æ±‚ç¤ºä¾‹:**
```json
{
  "goal": "å­¦ä¹ Python",
  "goalType": "goal_planning"
}
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "goal": "å­¦ä¹ Python",
  "goalType": "goal_planning",
  "questions": {
    "greeting": "å˜¿ï¼å¾ˆé«˜å…´ä½ å†³å®šå¼€å§‹å­¦ä¹ Pythonï¼Œæˆ‘æ¥å¸®ä½ è§„åˆ’ä¸€ä¸‹ï½",
    "questions": [
      "ä½ å­¦ä¹ Pythonçš„å…·ä½“ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿæ¯”å¦‚æ˜¯æƒ³åšæ•°æ®åˆ†æã€ç½‘ç«™å¼€å‘ï¼Œè¿˜æ˜¯è‡ªåŠ¨åŒ–è„šæœ¬ç­‰ç­‰ï¼Ÿ",
      "ä½ å¸Œæœ›åœ¨å¤šé•¿æ—¶é—´å†…è¾¾åˆ°è¿™ä¸ªç›®æ ‡å‘¢ï¼Ÿæ¯”å¦‚ä¸€ä¸ªæœˆã€ä¸‰ä¸ªæœˆï¼Œè¿˜æ˜¯æ›´çµæ´»ä¸€äº›ï¼Ÿ",
      "ä½ ç°åœ¨å¯¹Pythonçš„äº†è§£ç¨‹åº¦å¦‚ä½•ï¼Ÿæ˜¯å®Œå…¨é›¶åŸºç¡€ï¼Œè¿˜æ˜¯å·²ç»äº†è§£ä¸€äº›åŸºæœ¬è¯­æ³•ï¼Ÿ",
      "ä½ æ¯å¤©å¤§æ¦‚èƒ½æŠ½å‡ºå¤šå°‘æ—¶é—´æ¥å­¦ä¹ Pythonï¼Ÿæ¯”å¦‚30åˆ†é’Ÿã€1å°æ—¶ï¼Œè¿˜æ˜¯æ›´å¤šï¼Ÿ",
      "åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œä½ é‡åˆ°è¿‡ä»€ä¹ˆå›°éš¾å—ï¼Ÿæˆ–è€…ä½ è§‰å¾—å¯èƒ½ä¼šé‡åˆ°å“ªäº›æŒ‘æˆ˜ï¼Ÿ"
    ]
  },
  "timestamp": "2025-08-05T17:32:31.198Z"
}
```

### 6. ä¸»è¦å¤„ç†æµç¨‹

#### `POST /api/ai/process-input`
å¤„ç†ç”¨æˆ·è¾“å…¥çš„ä¸»è¦APIï¼ŒåŒ…å«åˆ†ç±»ã€é—®é¢˜ç”Ÿæˆç­‰å®Œæ•´æµç¨‹

**è¯·æ±‚å‚æ•°:**
- `userInput` (string, å¿…éœ€): ç”¨æˆ·è¾“å…¥å†…å®¹
- `userId` (string, å¯é€‰): ç”¨æˆ·ID

**è¯·æ±‚ç¤ºä¾‹:**
```json
{
  "userInput": "æˆ‘æƒ³å­¦ä¹ JavaScript",
  "userId": "test-user-123"
}
```

**å“åº”ç¤ºä¾‹ï¼ˆç›®æ ‡è§„åˆ’ç±»å‹ï¼‰:**
```json
{
  "success": true,
  "timestamp": "2025-08-05T17:32:45.143Z",
  "request": {
    "userInput": "æˆ‘æƒ³å­¦ä¹ JavaScript",
    "userId": "test-user-123"
  },
  "type": "goal_planning",
  "classification": {
    "category": "goal_planning",
    "confidence": 0.9,
    "reason": "å­¦ä¹ JavaScriptæ˜¯ä¸€ä¸ªéœ€è¦é•¿æœŸè§„åˆ’å’Œåˆ†æ­¥éª¤å®ç°çš„ç›®æ ‡ï¼Œæ¶‰åŠåˆ°ç³»ç»Ÿæ€§å­¦ä¹ å’ŒæŠ€èƒ½æå‡ã€‚"
  },
  "result": {
    "goal": "æˆ‘æƒ³å­¦ä¹ JavaScript",
    "questions": {
      "greeting": "å—¨ï¼å¾ˆé«˜å…´ä½ å†³å®šå­¦ä¹  JavaScriptï¼Œæˆ‘æ¥å¸®ä½ ä¸€èµ·è§„åˆ’ä¸€ä¸ªé€‚åˆä½ çš„å­¦ä¹ è®¡åˆ’å§ï½",
      "questions": [
        "ä½ å­¦ä¹  JavaScript çš„å…·ä½“ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿæ¯”å¦‚æ˜¯æƒ³åšç½‘é¡µå¼€å‘ã€å¼€å‘åº”ç”¨ï¼Œè¿˜æ˜¯åªæ˜¯ä¸ºäº†å…´è¶£ï¼Ÿ",
        "ä½ å¤§æ¦‚å¸Œæœ›åœ¨å¤šé•¿æ—¶é—´å†…æŒæ¡ JavaScript çš„åŸºç¡€çŸ¥è¯†å‘¢ï¼Ÿæ¯”å¦‚ä¸‰ä¸ªæœˆè¿˜æ˜¯åŠå¹´ï¼Ÿ",
        "ä½ ç°åœ¨å¯¹ç¼–ç¨‹æˆ– JavaScript çš„äº†è§£ç¨‹åº¦å¦‚ä½•ï¼Ÿæœ‰æ²¡æœ‰ç›¸å…³çš„åŸºç¡€æˆ–è€…ç»éªŒï¼Ÿ",
        "æ¯å¤©ä½ å¤§æ¦‚èƒ½æŠ½å‡ºå¤šå°‘æ—¶é—´æ¥å­¦ä¹  JavaScriptï¼Ÿæ¯”å¦‚æ˜¯æ—©ä¸Šã€æ™šä¸Šï¼Œè¿˜æ˜¯å‘¨æœ«æœ‰ç©ºï¼Ÿ",
        "ä½ åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­é‡åˆ°è¿‡å“ªäº›å›°éš¾ï¼Ÿæˆ–è€…ä½ è§‰å¾—åœ¨å­¦ä¹  JavaScript æ—¶æœ€å¤§çš„æŒ‘æˆ˜ä¼šæ˜¯ä»€ä¹ˆï¼Ÿ"
      ]
    },
    "next_step": "collect_answers",
    "message": "å—¨ï¼å¾ˆé«˜å…´ä½ å†³å®šå­¦ä¹  JavaScriptï¼Œæˆ‘æ¥å¸®ä½ ä¸€èµ·è§„åˆ’ä¸€ä¸ªé€‚åˆä½ çš„å­¦ä¹ è®¡åˆ’å§ï½"
  }
}
```

### 7. è®¡åˆ’ç”Ÿæˆ

#### `POST /api/ai/generate-plan`
æ ¹æ®ç”¨æˆ·å›ç­”ç”Ÿæˆè¯¦ç»†çš„æ‰§è¡Œè®¡åˆ’

**è¯·æ±‚å‚æ•°:**
- `goal` (string, å¿…éœ€): ç”¨æˆ·ç›®æ ‡
- `goalType` (string, å¿…éœ€): ç›®æ ‡ç±»å‹
- `userAnswers` (array, å¿…éœ€): ç”¨æˆ·å›ç­”æ•°ç»„
- `userId` (string, å¯é€‰): ç”¨æˆ·ID

**è¯·æ±‚ç¤ºä¾‹:**
```json
{
  "goal": "å­¦ä¹ JavaScript",
  "goalType": "goal_planning",
  "userAnswers": [
    "ç½‘é¡µå¼€å‘",
    "3ä¸ªæœˆ",
    "æœ‰HTMLåŸºç¡€",
    "æ¯å¤©2å°æ—¶",
    "ç†è§£å¤æ‚æ¦‚å¿µ"
  ],
  "userId": "test-user-123"
}
```

**å“åº”æ ¼å¼:**
```json
{
  "success": true,
  "type": "plan_generated",
  "result": {
    "message": "å·²ä¸ºä½ çš„ç›®æ ‡\"å­¦ä¹ JavaScript\"åˆ¶å®šäº†è¯¦ç»†è®¡åˆ’ï¼",
    "plan": {
      "plan_overview": "è®¡åˆ’æ¦‚è¿°",
      "collections": [
        {
          "name": "ä»»åŠ¡é›†åç§°",
          "description": "ä»»åŠ¡é›†æè¿°",
          "tasks": [
            {
              "title": "ä»»åŠ¡æ ‡é¢˜",
              "description": "ä»»åŠ¡æè¿°",
              "priority": "high|medium|low",
              "quadrant": 1-4,
              "timeBlock": {
                "timeBlockType": "morning|forenoon|afternoon|evening",
                "startTime": "09:00",
                "endTime": "11:00"
              },
              "dueDate": "2025-08-10",
              "tags": ["æ ‡ç­¾1", "æ ‡ç­¾2"]
            }
          ]
        }
      ],
      "suggestions": "æ‰§è¡Œå»ºè®®"
    },
    "summary": {
      "collections_count": 3,
      "tasks_count": 15,
      "estimated_duration": "å¾…è®¡ç®—"
    }
  }
}
```

### 8. è®¡åˆ’è°ƒæ•´

#### `POST /api/ai/adjust-plan`
æ ¹æ®ç”¨æˆ·åé¦ˆè°ƒæ•´ç°æœ‰è®¡åˆ’

**è¯·æ±‚å‚æ•°:**
- `planId` (string, å¿…éœ€): è®¡åˆ’ID
- `userFeedback` (string, å¿…éœ€): ç”¨æˆ·åé¦ˆ
- `userId` (string, å¯é€‰): ç”¨æˆ·ID

**è¯·æ±‚ç¤ºä¾‹:**
```json
{
  "planId": "plan-123",
  "userFeedback": "ä»»åŠ¡å¤ªå¤šäº†ï¼Œæˆ‘å®Œæˆä¸äº†",
  "userId": "test-user-123"
}
```

**å“åº”æ ¼å¼:**
```json
{
  "success": true,
  "type": "plan_adjusted",
  "result": {
    "message": "å·²æ ¹æ®ä½ çš„åé¦ˆè°ƒæ•´è®¡åˆ’ï¼šå‡å°‘ä»»åŠ¡é‡ï¼Œå»¶é•¿æ‰§è¡Œæ—¶é—´",
    "adjustment": {
      "adjustment_summary": "è°ƒæ•´æ¦‚è¿°",
      "mood_analysis": "æƒ…ç»ªåˆ†æç»“æœ",
      "changes": [
        {
          "type": "modify",
          "target": "ä»»åŠ¡ID",
          "description": "å˜æ›´æè¿°",
          "reason": "å˜æ›´åŸå› "
        }
      ],
      "encouragement": "é¼“åŠ±è¯­å¥"
    }
  }
}
```

## ğŸ“Š æ—¶é—´æ®µå®šä¹‰

- `morning`: 06:00-09:00 (æ—©æ™¨)
- `forenoon`: 09:00-12:00 (ä¸Šåˆ)
- `afternoon`: 12:00-18:00 (ä¸‹åˆ)
- `evening`: 18:00-23:00 (æ™šä¸Š)
- `unscheduled`: æœªå®‰æ’å…·ä½“æ—¶é—´

## ğŸ¯ ä¼˜å…ˆçº§å®šä¹‰

- `high`: é«˜ä¼˜å…ˆçº§ï¼ˆé‡è¦ä¸”ç´§æ€¥ï¼‰
- `medium`: ä¸­ä¼˜å…ˆçº§ï¼ˆé‡è¦ä½†ä¸ç´§æ€¥ï¼‰
- `low`: ä½ä¼˜å…ˆçº§ï¼ˆä¸é‡è¦ä¸ç´§æ€¥ï¼‰

## ğŸ“ˆ å››è±¡é™åˆ†ç±»

- `1`: é‡è¦ä¸”ç´§æ€¥
- `2`: é‡è¦ä¸ç´§æ€¥
- `3`: ç´§æ€¥ä¸é‡è¦
- `4`: ä¸é‡è¦ä¸ç´§æ€¥

## âŒ é”™è¯¯å¤„ç†

æ‰€æœ‰APIåœ¨å‘ç”Ÿé”™è¯¯æ—¶éƒ½ä¼šè¿”å›ä»¥ä¸‹æ ¼å¼ï¼š

```json
{
  "success": false,
  "error": "é”™è¯¯æè¿°",
  "details": "è¯¦ç»†é”™è¯¯ä¿¡æ¯",
  "timestamp": "2025-08-05T17:32:01.794Z"
}
```

å¸¸è§é”™è¯¯ç ï¼š
- `400`: è¯·æ±‚å‚æ•°é”™è¯¯
- `500`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
- `503`: AIæœåŠ¡è¿æ¥å¤±è´¥

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´å·¥ä½œæµç¨‹ç¤ºä¾‹

1. **ç”¨æˆ·è¾“å…¥å¤„ç†**
```bash
curl -X POST http://localhost:3001/api/ai/process-input \
  -H "Content-Type: application/json" \
  -d '{"userInput": "æˆ‘æƒ³å­¦ä¹ Python", "userId": "user123"}'
```

2. **æ”¶é›†ç”¨æˆ·å›ç­”åç”Ÿæˆè®¡åˆ’**
```bash
curl -X POST http://localhost:3001/api/ai/generate-plan \
  -H "Content-Type: application/json" \
  -d '{
    "goal": "å­¦ä¹ Python",
    "goalType": "goal_planning",
    "userAnswers": ["æ•°æ®åˆ†æ", "3ä¸ªæœˆ", "æ— åŸºç¡€", "æ¯å¤©1å°æ—¶", "ç†è§£è¯­æ³•"],
    "userId": "user123"
  }'
```

3. **æ ¹æ®åé¦ˆè°ƒæ•´è®¡åˆ’**
```bash
curl -X POST http://localhost:3001/api/ai/adjust-plan \
  -H "Content-Type: application/json" \
  -d '{
    "planId": "plan123",
    "userFeedback": "æ—¶é—´ä¸å¤Ÿ",
    "userId": "user123"
  }'
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. æ‰€æœ‰æ—¶é—´æˆ³éƒ½é‡‡ç”¨ISO 8601æ ¼å¼
2. ç”¨æˆ·IDè™½ç„¶æ˜¯å¯é€‰çš„ï¼Œä½†å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ä»¥æ”¯æŒå¤šç”¨æˆ·
3. AIæ¨¡å‹å“åº”æ—¶é—´å¯èƒ½è¾ƒé•¿ï¼ˆ5-15ç§’ï¼‰ï¼Œè¯·è®¾ç½®åˆé€‚çš„è¶…æ—¶æ—¶é—´
4. å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å®ç°è¯·æ±‚é™æµå’Œç¼“å­˜æœºåˆ¶

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒ

- Node.jsç‰ˆæœ¬ï¼šv18+
- ä¾èµ–çš„ä¸»è¦åŒ…ï¼š
  - express: Webæ¡†æ¶
  - openai: LLMå®¢æˆ·ç«¯
  - mongoose: MongoDBæ•°æ®åº“
  - cors: è·¨åŸŸæ”¯æŒ

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜è¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æŸ¥çœ‹é”™è¯¯æ—¥å¿—ã€‚